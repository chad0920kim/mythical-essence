{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <!-- Hero Section -->
    <div class="text-center mb-16">
        <h1 class="font-mythical text-5xl md:text-6xl text-gold mb-4 animate-float">
            {{ t.app_tagline }}
        </h1>
        <p class="text-xl text-gray-300 max-w-2xl mx-auto">
            {{ t.app_description }}
        </p>
    </div>

    <!-- Upload Section -->
    <div class="max-w-xl mx-auto">
        <div class="card-mythical p-8">
            <h2 class="font-mythical text-2xl text-center text-gold mb-6">
                {{ t.upload_title }}
            </h2>
            <p class="text-center text-gray-400 mb-8">
                {{ t.upload_subtitle }}
            </p>

            <!-- Upload Zone -->
            <form id="uploadForm" enctype="multipart/form-data">
                <div id="uploadZone" class="upload-zone rounded-xl p-12 text-center cursor-pointer transition-all">
                    <div id="uploadContent">
                        <div class="text-6xl mb-4">üì∏</div>
                        <button type="button" class="btn-mythical mb-4" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
                            {{ t.upload_button }}
                        </button>
                        <p class="text-gray-400">{{ t.upload_drag }}</p>
                        <p class="text-sm text-gray-500 mt-2">{{ t.upload_formats }}</p>
                    </div>

                    <!-- Preview (hidden by default) -->
                    <div id="previewContent" class="hidden">
                        <img id="previewImage" src="" alt="Preview" class="max-h-64 mx-auto rounded-lg mb-4">
                        <button type="button" class="text-gold hover:underline" onclick="resetUpload()">
                            {{ t.upload_button }}
                        </button>
                    </div>

                    <input type="file" id="fileInput" name="file" accept="image/jpeg,image/png,image/webp" class="hidden">
                </div>

                <!-- Analyze Button -->
                <button type="submit" id="analyzeBtn" class="btn-mythical w-full mt-6 hidden">
                    <span id="analyzeBtnText">‚ú® {{ t.analyzing }}</span>
                </button>
            </form>

            <p class="text-center text-sm text-gray-500 mt-6">
                üîí {{ t.upload_privacy }}
            </p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="text-center max-w-md mx-4">
            <div class="text-6xl mb-6 animate-float" id="loadingEmoji">üì∏</div>
            <h3 class="font-mythical text-2xl text-gold mb-2" id="loadingTitle">{{ t.analyzing }}</h3>
            <p class="text-gray-300 mb-2" id="loadingMessage">{{ t.analyzing_message }}</p>

            <!-- Progress Bar -->
            <div class="mt-6 w-full bg-gray-700 rounded-full overflow-hidden">
                <div id="progressBar" class="h-2 bg-gradient-to-r from-gold to-yellow-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-gray-400 text-sm mt-2" id="progressText">0%</p>

            <!-- Step Indicators -->
            <div class="mt-6 flex justify-center gap-3">
                <div id="step1" class="flex items-center gap-2 text-sm text-gray-500">
                    <span class="w-6 h-6 rounded-full border border-gray-600 flex items-center justify-center">1</span>
                    <span class="hidden sm:inline">{{ t.analyzing_step1 if t.analyzing_step1 else "Upload" }}</span>
                </div>
                <div id="step2" class="flex items-center gap-2 text-sm text-gray-500">
                    <span class="w-6 h-6 rounded-full border border-gray-600 flex items-center justify-center">2</span>
                    <span class="hidden sm:inline">{{ t.analyzing_step2 if t.analyzing_step2 else "Analyze" }}</span>
                </div>
                <div id="step3" class="flex items-center gap-2 text-sm text-gray-500">
                    <span class="w-6 h-6 rounded-full border border-gray-600 flex items-center justify-center">3</span>
                    <span class="hidden sm:inline">{{ t.analyzing_step3 if t.analyzing_step3 else "Match" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ad Modal -->
    <div id="adModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="card-mythical max-w-lg w-full mx-4 p-8 text-center">
            <h2 class="font-mythical text-2xl text-gold mb-4">{{ t.ad_modal_title }}</h2>
            <p class="text-gray-300 mb-6">{{ t.ad_modal_message }}</p>

            <!-- Ad Container -->
            <div id="adContainer" class="bg-gray-800 rounded-lg p-4 mb-6 min-h-[250px] flex items-center justify-center">
                {% if adsense_client_id and adsense_ad_slot %}
                <!-- AdSense Ad Unit -->
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="{{ adsense_client_id }}"
                     data-ad-slot="{{ adsense_ad_slot }}"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                {% else %}
                <!-- Placeholder for development -->
                <div id="adPlaceholder" class="text-gray-500">
                    <div class="text-4xl mb-2">üì∫</div>
                    <p>{{ t.ad_modal_watching }}</p>
                    <div id="adTimer" class="text-gold text-2xl mt-4">5</div>
                </div>
                {% endif %}
            </div>

            <!-- Status message -->
            <p id="adStatus" class="text-gray-400 mb-4 hidden">{{ t.ad_modal_complete }}</p>

            <!-- Buttons -->
            <div class="flex gap-4 justify-center">
                <button id="adContinueBtn" onclick="confirmAdWatched()" class="btn-mythical hidden">
                    {{ t.ad_modal_continue }}
                </button>
                <button onclick="closeAdModal()" class="px-6 py-3 border border-gray-600 text-gray-400 rounded-full hover:bg-gray-800 transition-colors">
                    {{ t.ad_modal_close }}
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden overflow-y-auto py-8">
        <div class="card-mythical max-w-2xl w-full mx-4 p-8">
            <h2 class="font-mythical text-3xl text-center text-gold mb-8">
                {{ t.result_title }}
            </h2>

            <!-- Primary Match -->
            <div id="primaryMatch" class="text-center mb-8">
                <!-- Filled by JavaScript -->
            </div>

            <!-- Match Details -->
            <div id="matchDetails" class="grid grid-cols-2 gap-4 mb-8">
                <!-- Filled by JavaScript -->
            </div>

            <!-- Analysis -->
            <div id="analysisText" class="text-gray-300 text-center mb-8 italic">
                <!-- Filled by JavaScript -->
            </div>

            <!-- Other Matches -->
            <div id="otherMatches" class="mb-8">
                <h3 class="font-mythical text-lg text-gold mb-4">{{ t.result_other_matches }}</h3>
                <div id="otherMatchesList" class="flex gap-2 flex-wrap">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="shareResult()" class="btn-mythical">
                    üîó {{ t.result_share }}
                </button>
                <button onclick="closeResult()" class="px-6 py-3 border border-gold text-gold rounded-full hover:bg-gold/10 transition-colors">
                    üîÑ {{ t.result_retry }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if adsense_client_id %}
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{ adsense_client_id }}"
     crossorigin="anonymous"></script>
{% endif %}
<script>
const translations = {{ t | tojson | safe }};

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const uploadForm = document.getElementById('uploadForm');
const analyzeBtn = document.getElementById('analyzeBtn');
const loadingOverlay = document.getElementById('loadingOverlay');
const resultModal = document.getElementById('resultModal');
const adModal = document.getElementById('adModal');

let selectedFile = null;
let pendingAnalysis = false;  // Flag to retry after ad

// Drag and drop handlers
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

uploadZone.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        alert('Please upload a JPG, PNG, or WebP image.');
        return;
    }

    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }

    selectedFile = file;

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('previewImage').src = e.target.result;
        document.getElementById('uploadContent').classList.add('hidden');
        document.getElementById('previewContent').classList.remove('hidden');
        analyzeBtn.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}

function resetUpload() {
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('uploadContent').classList.remove('hidden');
    document.getElementById('previewContent').classList.add('hidden');
    analyzeBtn.classList.add('hidden');
}

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!selectedFile) return;

    await performAnalysis();
});

// Progress update functions
let progressInterval = null;

const progressSteps = [
    { percent: 10, emoji: 'üì§', msg: translations.analyzing_msg1 || 'Uploading your photo...', step: 1 },
    { percent: 25, emoji: 'üîç', msg: translations.analyzing_msg2 || 'Detecting facial features...', step: 1 },
    { percent: 40, emoji: '‚ú®', msg: translations.analyzing_msg3 || 'Analyzing your essence...', step: 2 },
    { percent: 60, emoji: 'üìö', msg: translations.analyzing_msg4 || 'Searching mythological archives...', step: 2 },
    { percent: 75, emoji: '‚ö°', msg: translations.analyzing_msg5 || 'Finding your divine match...', step: 3 },
    { percent: 90, emoji: 'üåü', msg: translations.analyzing_msg6 || 'Almost there...', step: 3 }
];

function updateProgress(percent, emoji, message, activeStep) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '%';
    document.getElementById('loadingEmoji').textContent = emoji;
    document.getElementById('loadingMessage').textContent = message;

    // Update step indicators
    for (let i = 1; i <= 3; i++) {
        const stepEl = document.getElementById('step' + i);
        const circle = stepEl.querySelector('span');
        if (i < activeStep) {
            stepEl.classList.remove('text-gray-500');
            stepEl.classList.add('text-gold');
            circle.classList.remove('border-gray-600');
            circle.classList.add('border-gold', 'bg-gold/20');
        } else if (i === activeStep) {
            stepEl.classList.remove('text-gray-500');
            stepEl.classList.add('text-gold');
            circle.classList.remove('border-gray-600');
            circle.classList.add('border-gold');
        } else {
            stepEl.classList.add('text-gray-500');
            stepEl.classList.remove('text-gold');
            circle.classList.add('border-gray-600');
            circle.classList.remove('border-gold', 'bg-gold/20');
        }
    }
}

function startProgressAnimation() {
    let stepIndex = 0;
    updateProgress(progressSteps[0].percent, progressSteps[0].emoji, progressSteps[0].msg, progressSteps[0].step);

    progressInterval = setInterval(() => {
        stepIndex++;
        if (stepIndex < progressSteps.length) {
            const step = progressSteps[stepIndex];
            updateProgress(step.percent, step.emoji, step.msg, step.step);
        }
    }, 2500); // Change every 2.5 seconds
}

function stopProgressAnimation() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    // Reset progress bar
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
}

async function performAnalysis() {
    loadingOverlay.classList.remove('hidden');
    startProgressAnimation();

    const formData = new FormData();
    formData.append('file', selectedFile);

    try {
        const response = await fetch('/analyze', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        // Show completion
        updateProgress(100, '‚úÖ', translations.analyzing_complete || 'Analysis complete!', 3);
        await new Promise(resolve => setTimeout(resolve, 500));

        stopProgressAnimation();
        loadingOverlay.classList.add('hidden');

        if (data.success) {
            showResult(data);
        } else if (data.require_ad) {
            // Show ad modal
            pendingAnalysis = true;
            showAdModal();
        } else {
            alert(data.detail || data.message || translations.error_generic);
        }
    } catch (error) {
        stopProgressAnimation();
        loadingOverlay.classList.add('hidden');
        alert(translations.error_generic);
        console.error(error);
    }
}

// Ad Modal Functions
function showAdModal() {
    adModal.classList.remove('hidden');
    document.getElementById('adContinueBtn').classList.add('hidden');
    document.getElementById('adStatus').classList.add('hidden');

    // Start countdown for development placeholder
    const timerEl = document.getElementById('adTimer');
    if (timerEl) {
        let countdown = 5;
        timerEl.textContent = countdown;

        const interval = setInterval(() => {
            countdown--;
            timerEl.textContent = countdown;

            if (countdown <= 0) {
                clearInterval(interval);
                adComplete();
            }
        }, 1000);
    } else {
        // For real AdSense, trigger ad display
        try {
            (adsbygoogle = window.adsbygoogle || []).push({});
            // Wait for ad to load, then enable continue button
            setTimeout(adComplete, 5000);
        } catch (e) {
            console.log('AdSense not loaded');
            adComplete();
        }
    }
}

function adComplete() {
    document.getElementById('adContinueBtn').classList.remove('hidden');
    document.getElementById('adStatus').classList.remove('hidden');
    const placeholder = document.getElementById('adPlaceholder');
    if (placeholder) {
        placeholder.innerHTML = '<div class="text-4xl mb-2">‚úÖ</div><p class="text-gold">' + translations.ad_modal_complete + '</p>';
    }
}

function closeAdModal() {
    adModal.classList.add('hidden');
    pendingAnalysis = false;
}

async function confirmAdWatched() {
    try {
        const response = await fetch('/api/ad-watched', {
            method: 'POST'
        });

        if (response.ok) {
            adModal.classList.add('hidden');

            // Retry analysis if pending
            if (pendingAnalysis && selectedFile) {
                pendingAnalysis = false;
                await performAnalysis();
            }
        }
    } catch (error) {
        console.error('Error confirming ad:', error);
    }
}

function showResult(data) {
    const match = data.primary_match;

    // Primary match display
    document.getElementById('primaryMatch').innerHTML = `
        <div class="inline-block p-1 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-700 mb-4">
            <div class="w-32 h-32 rounded-full bg-gray-800 flex items-center justify-center text-5xl">
                ${getGodEmoji(match.archetype)}
            </div>
        </div>
        <h3 class="font-mythical text-3xl text-white mb-2">${match.god_name}</h3>
        <div class="text-gold text-xl">${match.match_score}% ${translations.result_match}</div>
    `;

    // Match details
    const cultureLabel = translations.cultures?.[match.culture] || match.culture;
    const archetypeLabel = translations.archetypes?.[match.archetype] || match.archetype;
    const elementLabel = translations.elements?.[match.element] || match.element;

    document.getElementById('matchDetails').innerHTML = `
        <div class="card-mythical p-4 text-center">
            <div class="text-gray-400 text-sm mb-1">${translations.result_culture}</div>
            <div class="text-white">${cultureLabel}</div>
        </div>
        <div class="card-mythical p-4 text-center">
            <div class="text-gray-400 text-sm mb-1">${translations.result_archetype}</div>
            <div class="text-white">${archetypeLabel}</div>
        </div>
        <div class="card-mythical p-4 text-center">
            <div class="text-gray-400 text-sm mb-1">${translations.result_element}</div>
            <div class="text-white">${elementLabel}</div>
        </div>
        <div class="card-mythical p-4 text-center">
            <div class="text-gray-400 text-sm mb-1">${translations.result_domain}</div>
            <div class="text-white text-sm">${match.domain}</div>
        </div>
    `;

    // Analysis text
    document.getElementById('analysisText').innerHTML = `"${match.reasoning}"`;

    // Other matches
    const otherMatchesHtml = data.other_matches.map(m => {
        const culture = translations.cultures?.[m.culture] || m.culture;
        return `
            <div class="card-mythical px-4 py-2 text-sm">
                <span class="text-white">${m.god_name}</span>
                <span class="text-gray-400">(${m.match_score}%)</span>
            </div>
        `;
    }).join('');
    document.getElementById('otherMatchesList').innerHTML = otherMatchesHtml;

    resultModal.classList.remove('hidden');
}

function getGodEmoji(archetype) {
    const emojis = {
        'ruler': 'üëë',
        'sage': 'üìö',
        'hero': '‚öîÔ∏è',
        'rebel': 'üî•',
        'wizard': 'üîÆ',
        'lover': 'üíï',
        'jester': 'üé≠',
        'caregiver': 'üíù',
        'creator': '‚ú®',
        'innocent': 'üåü',
        'explorer': 'üß≠',
        'everyman': 'ü§ù'
    };
    return emojis[archetype] || '‚ú¶';
}

function closeResult() {
    resultModal.classList.add('hidden');
    resetUpload();
}

function shareResult() {
    // Simple share implementation
    if (navigator.share) {
        navigator.share({
            title: translations.app_name,
            text: translations.app_description,
            url: window.location.href
        });
    } else {
        // Copy to clipboard
        navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
    }
}
</script>
{% endblock %}
