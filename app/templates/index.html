{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <!-- Hero Section -->
    <div class="text-center mb-16">
        <h1 class="font-mythical text-5xl md:text-6xl text-gold mb-4 animate-float">
            {{ t.app_tagline }}
        </h1>
        <p class="text-xl text-gray-300 max-w-2xl mx-auto">
            {{ t.app_description }}
        </p>
    </div>

    <!-- Upload Section -->
    <div class="max-w-xl mx-auto">
        <div class="card-mythical p-8">
            <h2 class="font-mythical text-2xl text-center text-gold mb-6">
                {{ t.upload_title }}
            </h2>
            <p class="text-center text-gray-400 mb-8">
                {{ t.upload_subtitle }}
            </p>

            <!-- Upload Zone -->
            <form id="uploadForm" enctype="multipart/form-data">
                <div id="uploadZone" class="upload-zone rounded-xl p-12 text-center cursor-pointer transition-all">
                    <div id="uploadContent">
                        <div class="text-6xl mb-4">üì∏</div>
                        <button type="button" class="btn-mythical mb-4" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
                            {{ t.upload_button }}
                        </button>
                        <p class="text-gray-400">{{ t.upload_drag }}</p>
                        <p class="text-sm text-gray-500 mt-2">{{ t.upload_formats }}</p>
                    </div>

                    <!-- Preview (hidden by default) -->
                    <div id="previewContent" class="hidden">
                        <img id="previewImage" src="" alt="Preview" class="max-h-64 mx-auto rounded-lg mb-4">
                        <button type="button" class="text-gold hover:underline" onclick="resetUpload()">
                            {{ t.upload_button }}
                        </button>
                    </div>

                    <input type="file" id="fileInput" name="file" accept="image/jpeg,image/png,image/webp" class="hidden">
                </div>

                <!-- Analyze Button -->
                <button type="submit" id="analyzeBtn" class="btn-mythical w-full mt-6 hidden">
                    <span id="analyzeBtnText">‚ú® {{ t.analyzing }}</span>
                </button>
            </form>

            <p class="text-center text-sm text-gray-500 mt-6">
                üîí {{ t.upload_privacy }}
            </p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="text-center max-w-md mx-4">
            <div class="text-6xl mb-6 animate-float" id="loadingEmoji">üì∏</div>
            <h3 class="font-mythical text-2xl text-gold mb-2" id="loadingTitle">{{ t.analyzing }}</h3>
            <p class="text-gray-300 mb-2" id="loadingMessage">{{ t.analyzing_message }}</p>

            <!-- Progress Bar -->
            <div class="mt-6 w-full bg-gray-700 rounded-full overflow-hidden">
                <div id="progressBar" class="h-2 bg-gradient-to-r from-gold to-yellow-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-gray-400 text-sm mt-2" id="progressText">0%</p>

            <!-- Step Indicators -->
            <div class="mt-6 flex justify-center gap-3">
                <div id="step1" class="flex items-center gap-2 text-sm text-gray-500">
                    <span class="w-6 h-6 rounded-full border border-gray-600 flex items-center justify-center">1</span>
                    <span class="hidden sm:inline">{{ t.analyzing_step1 if t.analyzing_step1 else "Upload" }}</span>
                </div>
                <div id="step2" class="flex items-center gap-2 text-sm text-gray-500">
                    <span class="w-6 h-6 rounded-full border border-gray-600 flex items-center justify-center">2</span>
                    <span class="hidden sm:inline">{{ t.analyzing_step2 if t.analyzing_step2 else "Analyze" }}</span>
                </div>
                <div id="step3" class="flex items-center gap-2 text-sm text-gray-500">
                    <span class="w-6 h-6 rounded-full border border-gray-600 flex items-center justify-center">3</span>
                    <span class="hidden sm:inline">{{ t.analyzing_step3 if t.analyzing_step3 else "Match" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ad Modal -->
    <div id="adModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="card-mythical max-w-lg w-full mx-4 p-8 text-center">
            <h2 class="font-mythical text-2xl text-gold mb-4">{{ t.ad_modal_title }}</h2>
            <p class="text-gray-300 mb-6">{{ t.ad_modal_message }}</p>

            <!-- Ad Container -->
            <div id="adContainer" class="bg-gray-800 rounded-lg p-4 mb-6 min-h-[250px] flex items-center justify-center">
                {% if adsense_client_id and adsense_ad_slot %}
                <!-- AdSense Ad Unit -->
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="{{ adsense_client_id }}"
                     data-ad-slot="{{ adsense_ad_slot }}"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                {% else %}
                <!-- Placeholder for development -->
                <div id="adPlaceholder" class="text-gray-500">
                    <div class="text-4xl mb-2">üì∫</div>
                    <p>{{ t.ad_modal_watching }}</p>
                    <div id="adTimer" class="text-gold text-2xl mt-4">5</div>
                </div>
                {% endif %}
            </div>

            <!-- Status message -->
            <p id="adStatus" class="text-gray-400 mb-4 hidden">{{ t.ad_modal_complete }}</p>

            <!-- Buttons -->
            <div class="flex gap-4 justify-center">
                <button id="adContinueBtn" onclick="confirmAdWatched()" class="btn-mythical hidden">
                    {{ t.ad_modal_continue }}
                </button>
                <button onclick="closeAdModal()" class="px-6 py-3 border border-gray-600 text-gray-400 rounded-full hover:bg-gray-800 transition-colors">
                    {{ t.ad_modal_close }}
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal - Character Selection -->
    <div id="resultModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden overflow-y-auto py-8">
        <div class="card-mythical max-w-4xl w-full mx-4 p-8">
            <h2 class="font-mythical text-3xl text-center text-gold mb-4">
                {{ t.result_title }}
            </h2>
            <p class="text-center text-gray-400 mb-8">
                {{ t.result_select_character if t.result_select_character else "Select a character to create your fusion!" }}
            </p>

            <!-- Top 3 Matches Grid -->
            <div id="matchesGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Filled by JavaScript -->
            </div>

            <!-- Face Analysis Summary -->
            <div id="faceAnalysisSummary" class="text-center text-gray-400 text-sm mb-6">
                <!-- Filled by JavaScript -->
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="closeResult()" class="px-6 py-3 border border-gold text-gold rounded-full hover:bg-gold/10 transition-colors">
                    üîÑ {{ t.result_retry }}
                </button>
            </div>
        </div>
    </div>

    <!-- Face Swap Result Modal -->
    <div id="swapResultModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden overflow-y-auto py-8">
        <div class="card-mythical max-w-2xl w-full mx-4 p-8">
            <h2 class="font-mythical text-3xl text-center text-gold mb-8">
                {{ t.swap_result_title if t.swap_result_title else "Your Mythical Fusion" }}
            </h2>

            <!-- Swap Result Image -->
            <div id="swapResultContent" class="text-center mb-8">
                <!-- Filled by JavaScript -->
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="shareSwapResult()" class="btn-mythical">
                    üîó {{ t.result_share }}
                </button>
                <button onclick="downloadSwapResult()" class="px-6 py-3 border border-gold text-gold rounded-full hover:bg-gold/10 transition-colors">
                    üì• {{ t.result_download if t.result_download else "Download" }}
                </button>
                <button onclick="closeSwapResult()" class="px-6 py-3 border border-gray-600 text-gray-400 rounded-full hover:bg-gray-800 transition-colors">
                    üîÑ {{ t.result_retry }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if adsense_client_id %}
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{ adsense_client_id }}"
     crossorigin="anonymous"></script>
{% endif %}
<script>
const translations = {{ t | tojson | safe }};

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const uploadForm = document.getElementById('uploadForm');
const analyzeBtn = document.getElementById('analyzeBtn');
const loadingOverlay = document.getElementById('loadingOverlay');
const resultModal = document.getElementById('resultModal');
const swapResultModal = document.getElementById('swapResultModal');
const adModal = document.getElementById('adModal');

let selectedFile = null;
let pendingAnalysis = false;  // Flag to retry after ad
let currentResultId = null;   // Store result ID for face swap
let selectedGodId = null;     // Store selected god ID for face swap
let lastSwapResult = null;    // Store last swap result for download

// Drag and drop handlers
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

uploadZone.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        alert('Please upload a JPG, PNG, or WebP image.');
        return;
    }

    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }

    selectedFile = file;

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('previewImage').src = e.target.result;
        document.getElementById('uploadContent').classList.add('hidden');
        document.getElementById('previewContent').classList.remove('hidden');
        analyzeBtn.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}

function resetUpload() {
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('uploadContent').classList.remove('hidden');
    document.getElementById('previewContent').classList.add('hidden');
    analyzeBtn.classList.add('hidden');
}

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!selectedFile) return;

    await performAnalysis();
});

// Progress update functions
let progressInterval = null;

const progressSteps = [
    { percent: 10, emoji: 'üì§', msg: translations.analyzing_msg1 || 'Uploading your photo...', step: 1 },
    { percent: 25, emoji: 'üîç', msg: translations.analyzing_msg2 || 'Detecting facial features...', step: 1 },
    { percent: 40, emoji: '‚ú®', msg: translations.analyzing_msg3 || 'Analyzing your essence...', step: 2 },
    { percent: 60, emoji: 'üìö', msg: translations.analyzing_msg4 || 'Searching mythological archives...', step: 2 },
    { percent: 75, emoji: '‚ö°', msg: translations.analyzing_msg5 || 'Finding your divine match...', step: 3 },
    { percent: 90, emoji: 'üåü', msg: translations.analyzing_msg6 || 'Almost there...', step: 3 }
];

function updateProgress(percent, emoji, message, activeStep) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '%';
    document.getElementById('loadingEmoji').textContent = emoji;
    document.getElementById('loadingMessage').textContent = message;

    // Update step indicators
    for (let i = 1; i <= 3; i++) {
        const stepEl = document.getElementById('step' + i);
        const circle = stepEl.querySelector('span');
        if (i < activeStep) {
            stepEl.classList.remove('text-gray-500');
            stepEl.classList.add('text-gold');
            circle.classList.remove('border-gray-600');
            circle.classList.add('border-gold', 'bg-gold/20');
        } else if (i === activeStep) {
            stepEl.classList.remove('text-gray-500');
            stepEl.classList.add('text-gold');
            circle.classList.remove('border-gray-600');
            circle.classList.add('border-gold');
        } else {
            stepEl.classList.add('text-gray-500');
            stepEl.classList.remove('text-gold');
            circle.classList.add('border-gray-600');
            circle.classList.remove('border-gold', 'bg-gold/20');
        }
    }
}

function startProgressAnimation() {
    let stepIndex = 0;
    updateProgress(progressSteps[0].percent, progressSteps[0].emoji, progressSteps[0].msg, progressSteps[0].step);

    progressInterval = setInterval(() => {
        stepIndex++;
        if (stepIndex < progressSteps.length) {
            const step = progressSteps[stepIndex];
            updateProgress(step.percent, step.emoji, step.msg, step.step);
        }
    }, 2500); // Change every 2.5 seconds
}

function stopProgressAnimation() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    // Reset progress bar
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
}

async function performAnalysis() {
    loadingOverlay.classList.remove('hidden');
    startProgressAnimation();

    const formData = new FormData();
    formData.append('file', selectedFile);

    // Create abort controller for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout

    try {
        console.log('Starting analysis...');
        const response = await fetch('/analyze', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        });

        clearTimeout(timeoutId);
        console.log('Response received:', response.status);

        const data = await response.json();
        console.log('Data parsed:', data);

        // Show completion
        updateProgress(100, '‚úÖ', translations.analyzing_complete || 'Analysis complete!', 3);
        await new Promise(resolve => setTimeout(resolve, 500));

        stopProgressAnimation();
        loadingOverlay.classList.add('hidden');

        if (data.success) {
            console.log('Showing result with matches:', data.matches?.length);
            showResult(data);
        } else if (data.require_ad) {
            // Show ad modal
            pendingAnalysis = true;
            showAdModal();
        } else {
            alert(data.detail || data.message || translations.error_generic);
        }
    } catch (error) {
        clearTimeout(timeoutId);
        stopProgressAnimation();
        loadingOverlay.classList.add('hidden');

        console.error('Analysis error:', error);
        if (error.name === 'AbortError') {
            alert(translations.error_timeout || 'Analysis timed out. Please try again.');
        } else {
            alert((translations.error_generic || 'Something went wrong.') + ' Error: ' + error.message);
        }
    }
}

// Ad Modal Functions
function showAdModal() {
    adModal.classList.remove('hidden');
    document.getElementById('adContinueBtn').classList.add('hidden');
    document.getElementById('adStatus').classList.add('hidden');

    // Start countdown for development placeholder
    const timerEl = document.getElementById('adTimer');
    if (timerEl) {
        let countdown = 5;
        timerEl.textContent = countdown;

        const interval = setInterval(() => {
            countdown--;
            timerEl.textContent = countdown;

            if (countdown <= 0) {
                clearInterval(interval);
                adComplete();
            }
        }, 1000);
    } else {
        // For real AdSense, trigger ad display
        try {
            (adsbygoogle = window.adsbygoogle || []).push({});
            // Wait for ad to load, then enable continue button
            setTimeout(adComplete, 5000);
        } catch (e) {
            console.log('AdSense not loaded');
            adComplete();
        }
    }
}

function adComplete() {
    document.getElementById('adContinueBtn').classList.remove('hidden');
    document.getElementById('adStatus').classList.remove('hidden');
    const placeholder = document.getElementById('adPlaceholder');
    if (placeholder) {
        placeholder.innerHTML = '<div class="text-4xl mb-2">‚úÖ</div><p class="text-gold">' + translations.ad_modal_complete + '</p>';
    }
}

function closeAdModal() {
    adModal.classList.add('hidden');
    pendingAnalysis = false;
}

async function confirmAdWatched() {
    try {
        const response = await fetch('/api/ad-watched', {
            method: 'POST'
        });

        if (response.ok) {
            adModal.classList.add('hidden');

            // If a character was selected, perform face swap
            if (selectedGodId && currentResultId) {
                await performFaceSwap();
            }
            // Legacy: Retry analysis if pending
            else if (pendingAnalysis && selectedFile) {
                pendingAnalysis = false;
                await performAnalysis();
            }
        }
    } catch (error) {
        console.error('Error confirming ad:', error);
    }
}

function showResult(data) {
    try {
        console.log('showResult called with:', JSON.stringify(data).substring(0, 200));

        // Store result ID for face swap
        currentResultId = data.result_id;

        // Build character cards for top 3 matches
        const matchesHtml = data.matches.map((match, index) => {
        const cultureLabel = translations.cultures?.[match.culture] || match.culture;
        const archetypeLabel = translations.archetypes?.[match.archetype] || match.archetype;

        // Determine image
        let imageHtml;
        if (match.character_image_url) {
            imageHtml = `<img src="${match.character_image_url}" alt="${match.god_name}" class="w-32 h-32 rounded-full object-cover border-4 border-gold/50 group-hover:border-gold transition-all">`;
        } else {
            imageHtml = `<div class="w-32 h-32 rounded-full bg-gray-800 flex items-center justify-center text-5xl border-4 border-gold/50 group-hover:border-gold transition-all">${getGodEmoji(match.archetype)}</div>`;
        }

        // Ranking badge
        const rankBadge = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';

        return `
            <div class="card-mythical p-6 text-center cursor-pointer group hover:border-gold transition-all relative" onclick="selectCharacter('${match.god_id}', '${match.god_name}')">
                <div class="absolute top-3 right-3 text-2xl">${rankBadge}</div>
                <div class="inline-block p-1 rounded-full bg-gradient-to-r from-yellow-500/20 to-yellow-700/20 mb-4 group-hover:from-yellow-500/40 group-hover:to-yellow-700/40 transition-all">
                    ${imageHtml}
                </div>
                <h3 class="font-mythical text-xl text-white mb-2">${match.god_name}</h3>
                <div class="text-gold text-lg mb-3">${match.match_score}% ${translations.result_match || 'Match'}</div>
                <div class="text-gray-400 text-sm mb-2">${cultureLabel} ¬∑ ${archetypeLabel}</div>
                <p class="text-gray-500 text-xs line-clamp-2">${match.reasoning}</p>
                <button class="btn-mythical mt-4 text-sm py-2 px-4 opacity-0 group-hover:opacity-100 transition-opacity">
                    ‚ú® ${translations.select_character || 'Select'}
                </button>
            </div>
        `;
    }).join('');

    document.getElementById('matchesGrid').innerHTML = matchesHtml;

    // Face analysis summary
    const analysis = data.face_analysis;
    document.getElementById('faceAnalysisSummary').innerHTML = `
        ${translations.face_analysis_label || 'Your face analysis'}:
        ${translations.face_shapes?.[analysis.face_shape] || analysis.face_shape} ¬∑
        ${translations.eye_types?.[analysis.eye_type] || analysis.eye_type} ¬∑
        ${translations.symmetry_label || 'Symmetry'}: ${analysis.symmetry}%
    `;

        resultModal.classList.remove('hidden');
        console.log('Result modal shown successfully');
    } catch (error) {
        console.error('Error in showResult:', error);
        alert('Error displaying results: ' + error.message);
    }
}

function selectCharacter(godId, godName) {
    selectedGodId = godId;

    // Show ad modal before face swap
    showAdModal();
}

async function performFaceSwap() {
    if (!currentResultId || !selectedGodId) {
        alert('Please select a character first.');
        return;
    }

    // Show loading
    loadingOverlay.classList.remove('hidden');
    document.getElementById('loadingTitle').textContent = translations.creating_fusion || 'Creating your fusion...';
    document.getElementById('loadingMessage').textContent = translations.creating_fusion_msg || 'Merging your essence with the mythical...';
    startProgressAnimation();

    const formData = new FormData();
    formData.append('result_id', currentResultId);
    formData.append('god_id', selectedGodId);

    try {
        const response = await fetch('/api/swap-face', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        stopProgressAnimation();
        loadingOverlay.classList.add('hidden');

        if (data.success) {
            showSwapResult(data);
        } else if (data.require_ad) {
            showAdModal();
        } else {
            alert(data.detail || data.message || translations.error_generic);
        }
    } catch (error) {
        stopProgressAnimation();
        loadingOverlay.classList.add('hidden');
        alert(translations.error_generic || 'Something went wrong. Please try again.');
        console.error('Face swap error:', error);
    }
}

function showSwapResult(data) {
    lastSwapResult = data;

    // Determine image source
    let imageHtml;
    if (data.result_image) {
        imageHtml = `<img id="swapResultImage" src="data:image/png;base64,${data.result_image}" alt="Your Fusion" class="max-w-md w-full rounded-2xl border-4 border-gold shadow-2xl">`;
    } else if (data.character_image_url) {
        imageHtml = `<img id="swapResultImage" src="${data.character_image_url}" alt="Character" class="max-w-md w-full rounded-2xl border-4 border-gold shadow-2xl">`;
    } else {
        imageHtml = `<div class="w-64 h-64 rounded-2xl bg-gray-800 flex items-center justify-center text-6xl border-4 border-gold">‚ú®</div>`;
    }

    const godName = data.god_id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

    document.getElementById('swapResultContent').innerHTML = `
        <div class="inline-block p-2 rounded-2xl bg-gradient-to-r from-yellow-500/30 to-yellow-700/30 mb-6">
            ${imageHtml}
        </div>
        <h3 class="font-mythical text-2xl text-white mb-2">${translations.fusion_with || 'Your Fusion with'} ${godName}</h3>
        <p class="text-gray-400">${translations.fusion_complete || 'The mythical transformation is complete!'}</p>
    `;

    // Hide result modal and show swap result
    resultModal.classList.add('hidden');
    swapResultModal.classList.remove('hidden');
}

function closeSwapResult() {
    swapResultModal.classList.add('hidden');
    resetUpload();
    currentResultId = null;
    selectedGodId = null;
    lastSwapResult = null;
}

function shareSwapResult() {
    if (navigator.share) {
        navigator.share({
            title: translations.app_name || 'MythFace',
            text: translations.share_text || 'Check out my mythical fusion!',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href);
        alert(translations.link_copied || 'Link copied to clipboard!');
    }
}

function downloadSwapResult() {
    if (!lastSwapResult) return;

    const link = document.createElement('a');
    if (lastSwapResult.result_image) {
        link.href = `data:image/png;base64,${lastSwapResult.result_image}`;
        link.download = `mythface_${lastSwapResult.god_id}.png`;
    } else if (lastSwapResult.character_image_url) {
        link.href = lastSwapResult.character_image_url;
        link.download = `mythface_${lastSwapResult.god_id}.png`;
    }
    link.click();
}

function getGodEmoji(archetype) {
    const emojis = {
        'ruler': 'üëë',
        'sage': 'üìö',
        'hero': '‚öîÔ∏è',
        'rebel': 'üî•',
        'wizard': 'üîÆ',
        'lover': 'üíï',
        'jester': 'üé≠',
        'caregiver': 'üíù',
        'creator': '‚ú®',
        'innocent': 'üåü',
        'explorer': 'üß≠',
        'everyman': 'ü§ù'
    };
    return emojis[archetype] || '‚ú¶';
}

function closeResult() {
    resultModal.classList.add('hidden');
    resetUpload();
}

function shareResult() {
    // Simple share implementation
    if (navigator.share) {
        navigator.share({
            title: translations.app_name,
            text: translations.app_description,
            url: window.location.href
        });
    } else {
        // Copy to clipboard
        navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
    }
}
</script>
{% endblock %}
